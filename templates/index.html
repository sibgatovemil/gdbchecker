{% extends "base.html" %}

{% block title %}Dashboard - GDBChecker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
    </div>
    <div class="col text-end">
        <button class="btn btn-warning" onclick="checkAllDomains()">
            <i class="bi bi-arrow-repeat"></i> Проверить домены
        </button>
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#importCsvModal">
            <i class="bi bi-upload"></i> Импорт CSV
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDomainModal">
            <i class="bi bi-plus-circle"></i> Добавить домен
        </button>
        <a href="/api/export/csv" class="btn btn-success">
            <i class="bi bi-download"></i> Экспорт CSV
        </a>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card total">
            <div class="card-body">
                <h5 class="card-title">Total Domains</h5>
                <h2 class="card-text">{{ stats.total }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card ok">
            <div class="card-body">
                <h5 class="card-title">OK</h5>
                <h2 class="card-text text-success">{{ stats.ok }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card banned">
            <div class="card-body">
                <h5 class="card-title">Banned</h5>
                <h2 class="card-text text-danger">{{ stats.banned }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card error">
            <div class="card-body">
                <h5 class="card-title">Errors</h5>
                <h2 class="card-text text-warning">{{ stats.error }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Filter -->
<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" id="searchInput" class="form-control" placeholder="Search domains...">
    </div>
    <div class="col-md-3">
        <select id="statusFilter" class="form-select">
            <option value="">All Statuses</option>
            <option value="ok">OK</option>
            <option value="banned">Banned</option>
            <option value="error">Error</option>
            <option value="pending">Pending</option>
        </select>
    </div>
</div>

<!-- Domains Table -->
<div class="card">
    <div class="card-header">
        <h5><i class="bi bi-list-ul"></i> Domains</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="domainsTable">
                <thead>
                    <tr>
                        <th>Domain</th>
                        <th>Project</th>
                        <th>Purpose</th>
                        <th>SafeBrowsing</th>
                        <th>SSL</th>
                        <th>Last Check</th>
                        <th>Добавлен</th>
                        <th>Добавил</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for domain in domains %}
                    <tr data-status="{{ domain.current_status }}" data-domain="{{ domain.domain }}">
                        <td>
                            <a href="/domain/{{ domain.id }}" class="text-decoration-none">
                                <strong>{{ domain.domain }}</strong>
                            </a>
                        </td>
                        <td>{{ domain.project or '-' }}</td>
                        <td>{{ domain.purpose or '-' }}</td>
                        <td>
                            <span class="badge status-badge status-{{ domain.current_status }}">
                                {% if domain.current_status == 'ok' %}
                                    <i class="bi bi-check-circle"></i> OK
                                {% elif domain.current_status == 'banned' %}
                                    <i class="bi bi-x-circle"></i> BANNED
                                {% elif domain.current_status == 'error' %}
                                    <i class="bi bi-exclamation-triangle"></i> ERROR
                                {% else %}
                                    <i class="bi bi-clock"></i> PENDING
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="badge status-badge status-{{ domain.ssl_status or 'pending' }}">
                                {% if domain.ssl_status == 'valid' %}
                                    <i class="bi bi-shield-check"></i> VALID
                                {% elif domain.ssl_status == 'expired' %}
                                    <i class="bi bi-shield-exclamation"></i> EXPIRED
                                {% elif domain.ssl_status == 'invalid' %}
                                    <i class="bi bi-shield-x"></i> INVALID
                                {% elif domain.ssl_status == 'missing' %}
                                    <i class="bi bi-shield-slash"></i> MISSING
                                {% else %}
                                    <i class="bi bi-clock"></i> PENDING
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            {% if domain.last_check_time %}
                                {{ domain.last_check_time|moscow_time }}
                            {% else %}
                                Никогда
                            {% endif %}
                        </td>
                        <td>
                            {% if domain.created_at %}
                                {{ domain.created_at|moscow_time }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ domain.added_by or 'Неизвестно' }}</td>
                        <td>
                            <a href="/domain/{{ domain.id }}" class="btn btn-sm btn-info">
                                <i class="bi bi-eye"></i>
                            </a>
                            <button class="btn btn-sm btn-danger" onclick="deleteDomain({{ domain.id }}, '{{ domain.domain }}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Domain Modal -->
<div class="modal fade" id="addDomainModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Domain</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addDomainForm">
                    <div class="mb-3">
                        <label for="domain" class="form-label">Domain *</label>
                        <input type="text" class="form-control" id="domain" required placeholder="example.com">
                    </div>
                    <div class="mb-3">
                        <label for="project" class="form-label">Project</label>
                        <input type="text" class="form-control" id="project" placeholder="Project name">
                    </div>
                    <div class="mb-3">
                        <label for="purpose" class="form-label">Purpose</label>
                        <input type="text" class="form-control" id="purpose" placeholder="Landing, Traffic, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addDomain()">Add Domain</button>
            </div>
        </div>
    </div>
</div>

<!-- Import CSV Modal -->
<div class="modal fade" id="importCsvModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Domains from CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="importCsvForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">Select CSV File</label>
                        <input type="file" class="form-control" id="csvFile" accept=".csv" required>
                    </div>
                    <div class="alert alert-info">
                        <strong>CSV Format:</strong>
                        <ul class="mb-0">
                            <li>Required column: <code>domain</code> (or Domain, DOMAIN, url, URL)</li>
                            <li>Optional columns: <code>project</code>, <code>purpose</code></li>
                            <li>Example: domain,project,purpose</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="importCsv()">Import</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Search and filter
document.getElementById('searchInput').addEventListener('keyup', filterTable);
document.getElementById('statusFilter').addEventListener('change', filterTable);

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#domainsTable tbody tr');

    rows.forEach(row => {
        const domain = row.dataset.domain.toLowerCase();
        const status = row.dataset.status;

        const matchesSearch = domain.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;

        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
}

// Add domain
async function addDomain() {
    const domain = document.getElementById('domain').value.trim();
    const project = document.getElementById('project').value.trim();
    const purpose = document.getElementById('purpose').value.trim();

    if (!domain) {
        alert('Domain is required');
        return;
    }

    try {
        const response = await fetch('/api/domains', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ domain, project, purpose })
        });

        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Network error: ' + e.message);
    }
}

// Delete domain
async function deleteDomain(id, domain) {
    if (!confirm(`Delete domain "${domain}"?`)) return;

    try {
        const response = await fetch(`/api/domains/${id}`, { method: 'DELETE' });
        if (response.ok) {
            location.reload();
        } else {
            alert('Error deleting domain');
        }
    } catch (e) {
        alert('Network error: ' + e.message);
    }
}

// Check all domains
async function checkAllDomains() {
    if (!confirm('Запустить проверку всех доменов?\n\nПосле проверки автоматически будет отправлен отчет в Telegram.\n\nЭто займет несколько минут.')) return;

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Проверка...';

    try {
        const response = await fetch('/api/check-domains', { method: 'POST' });
        const data = await response.json();

        if (response.ok) {
            alert('✅ Проверка доменов запущена в фоне.\n\nПо завершении:\n• Отчет будет отправлен в Telegram\n• Обновите страницу через 2-3 минуты для просмотра результатов');
        } else {
            alert('❌ Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (e) {
        alert('❌ Ошибка сети: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Import CSV
async function importCsv() {
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];

    if (!file) {
        alert('Please select a CSV file');
        return;
    }

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Importing...';

    try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/api/import/csv', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok) {
            let message = `✅ Import completed!\n\n`;
            message += `• Added: ${data.added} domains\n`;
            message += `• Skipped (duplicates): ${data.skipped}\n`;
            if (data.errors.length > 0) {
                message += `\n⚠️ Errors (${data.errors.length}):\n`;
                message += data.errors.slice(0, 5).join('\n');
                if (data.errors.length > 5) {
                    message += `\n... and ${data.errors.length - 5} more errors`;
                }
            }
            alert(message);
            location.reload();
        } else {
            alert('❌ Error: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        alert('❌ Network error: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
</script>
{% endblock %}
